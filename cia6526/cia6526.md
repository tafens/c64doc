# MOS 6526 CIA

## Timers

The 6526 has two timers, timer A and timer B. The timers count down from a set 16-bit value down to zero and can either stop there or restart from the same value. Each time a timer reaches zero, an underflow condition occurs that sets that timer's flag in the interrupt register, and if the interrupt mask register also has that timer’s flag set, an interrupt is generated.

### Initial values
On power on/reset the current value of timers will be 0x0000 and the latch will be 0xFFFF.

### Ticks

Each timer has a tick source. For timer A the source can be one of phi2 clock, or positive CNT pin transitions. For timer B the source can be one of phi2 clock, positive CNT pin transitions, timer A underflows, or timer A underflows while CNT pin is high.

The timer is always ticked in unison with the phi2 clock. In phi2 mode, the timer is always ticked with each phi2 clock as the tick source generates one tick each clock cycle. In CNT mode however, the tick source only generates a tick if the CNT pin has transitioned from low to high some time during the previous clock cycle.

### Latency and stall

#### Start/Stop and underflow
In the second clock cycle after bit 0 (”running”) in the timer's control register has been set, the timer starts counting down from its current value back to zero. When it has reached zero and there is another tick incoming, an underflow event occurs and the timer is immediately reloaded from the latch. The reload itself however stalls the timer for one cycle, and any tick incoming during that time is ignored. The interrupt control register bit for the timer will be set immediately on underflow, and if interrupts are enabled for the timer, the IRQ pin will go low on the next clock cycle. 

#### Force reload
In the next clock cycle after bit 4 ("force load") in the timer's control register has been set, the timer is reloaded from the latch. As with a normal underflow, the reload stalls the timer for one cycle, and any tick incoming during that time is ignored.

#### Writing to the latch
Writing to the latch always updates the value in the latch that will be used on the next reaload of the timer. If the timer is stopped at the time of writing the high byte of the latch, the value will also set the current value of the timer (however the new value will take on additional cycle to load into the current value of the timer - just as with underflow and forced reload). If the timer is running, the new value in the latch will not be used until the timer is reloaded. 

---

### Notes
In phi2 mode there is always another tick inbound, so a zero value will never be seen, and the latch value will be seen for two consecutive clocks before the count down is commenced.
